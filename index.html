<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shimla Smart POS 2026</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <style>
        :root { --primary: #27ae60; --danger: #e74c3c; --bg: #121212; --panel: #ffffff; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); color: white; overflow: hidden; }
        #camera-section { height: 35vh; position: relative; background: #000; }
        #webcam { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; }
        .profit-badge { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.7); padding: 8px 15px; border-radius: 20px; border: 1px solid var(--primary); font-size: 13px; color: var(--primary); font-weight: bold;}
        #billing-section { height: 65vh; background: var(--panel); color: #333; border-top-left-radius: 25px; border-top-right-radius: 25px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 -10px 30px rgba(0,0,0,0.3); }
        .item-list { flex-grow: 1; overflow-y: auto; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .summary-card { background: #f9f9f9; padding: 15px; border-radius: 15px; margin-bottom: 15px; }
        .summary-line { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px; }
        .total-bill { font-size: 24px; font-weight: 800; border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 5px; }
        .qty-box { display: flex; align-items: center; gap: 10px; }
        .btn-qty { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #ddd; background: #fff; font-weight: bold; }
        .main-btn { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 15px; font-size: 18px; font-weight: bold; }
        #weight-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:200; }
        .weight-box { background:#fff; padding:25px; border-radius:20px; width:85%; text-align:center; }
        .grid-weights { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin:20px 0; }
        .w-btn { padding:15px; font-size:16px; font-weight:bold; border:1px solid #ddd; border-radius:10px; background:#f8f9fa; }
    </style>
</head>
<body>

<div id="camera-section">
    <video id="webcam" autoplay playsinline muted></video>
    <div class="profit-badge">Today's Profit: ₹<span id="profit-val">0</span></div>
</div>

<div id="billing-section">
    <div class="item-list" id="cart">
        <p style="text-align:center; color:#999; margin-top:30px;">Waiting for scan...</p>
    </div>
    <div class="summary-card">
        <div class="summary-line"><span>Total Items:</span> <b id="total-qty">0</b></div>
        <div class="summary-line" style="color:var(--primary)"><span>Total Discount:</span> <b>- ₹<span id="total-disc">0</span></b></div>
        <div class="summary-line total-bill"><span>TOTAL</span> <span>₹<span id="total-amt">0</span></span></div>
    </div>
    <button class="main-btn" onclick="generateInvoice()">GENERATE INVOICE</button>
</div>

<div id="weight-modal"><div class="weight-box">
    <h3 id="weight-title">Select Weight</h3>
    <div class="grid-weights">
        <button class="w-btn" onclick="handleWeight(250)">250g</button>
        <button class="w-btn" onclick="handleWeight(500)">500g</button>
        <button class="w-btn" onclick="handleWeight(1000)">1kg</button>
        <button class="w-btn" onclick="handleWeight(2000)">2kg</button>
        <button class="w-btn" onclick="handleWeight(5000)">5kg</button>
        <button class="w-btn" style="background:#3498db; color:white;" onclick="handleManualWeight()">Custom</button>
    </div>
    <button onclick="closeWeight()" style="border:none; background:none; color:#777;">Cancel</button>
</div></div>

<script>
    // 1. YOUR LINKS ARE NOW ADDED
    const TEACHABLE_URL = "https://teachablemachine.withgoogle.com/models/cycqkc30S/"; 
    const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQyhBP3yyTYrAJR_-luY7Yr5P7PVKLHRleiH9LWMTASiL7sh0HpZDf2ji5s__ddYcSaS-9aFg5Epz9x/pub?output=csv";

    let inventory = {}, cart = {};
    let lastScanTime = 0, lastItem = null;
    let currentWeightItemId = null;
    let dailyProfit = parseFloat(localStorage.getItem('dayProfit')) || 0;
    document.getElementById('profit-val').innerText = dailyProfit.toFixed(0);

    // 2. LOAD DATA
    async function loadData() {
        try {
            const res = await fetch(SHEET_CSV);
            const text = await res.text();
            text.split('\n').slice(1).forEach(r => {
                const cols = r.split(',');
                if(cols[0]) {
                    inventory[cols[0].trim()] = { 
                        name: cols[1].trim(), 
                        mrp: parseFloat(cols[2]), 
                        price: parseFloat(cols[3]) 
                    };
                }
            });
            startAI();
        } catch (e) { alert("Check your Google Sheet 'Publish to Web' setting."); }
    }

    // 3. AI ENGINE
    async function startAI() {
        const model = await tmImage.load(TEACHABLE_URL+"model.json", TEACHABLE_URL+"metadata.json");
        const video = document.getElementById('webcam');
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;

        async function loop() {
            const prediction = await model.predict(video);
            let top = { probability: 0, className: "" };
            prediction.forEach(p => { if(p.probability > top.probability) top = p; });

            if(top.probability > 0.98 && top.className !== "Background") {
                const now = Date.now();
                if(top.className !== lastItem || (now - lastScanTime) > 3000) {
                    processItem(top.className);
                    lastItem = top.className; lastScanTime = now;
                }
            }
            requestAnimationFrame(loop);
        }
        loop();
    }

    // 4. BILLING LOGIC
    function processItem(id) {
        if(!inventory[id]) return;
        const looseWords = ["atta", "rice", "dal", "sugar", "loose"];
        const isLoose = looseWords.some(k => id.toLowerCase().includes(k));
        if(isLoose) {
            currentWeightItemId = id;
            document.getElementById('weight-title').innerText = inventory[id].name;
            document.getElementById('weight-modal').style.display = 'flex';
        } else {
            addSingle(id);
        }
    }

    function addSingle(id) {
        if(cart[id]) cart[id].qty++;
        else cart[id] = { ...inventory[id], qty: 1, isWeight: false };
        beep(); render();
    }

    function handleWeight(grams) {
        const id = currentWeightItemId;
        const uid = id + "_" + Date.now();
        cart[uid] = { name: `${inventory[id].name} (${grams}g)`, mrp: inventory[id].mrp, price: inventory[id].price, qty: grams/1000, isWeight: true };
        closeWeight(); beep(); render();
    }

    function handleManualWeight() {
        const g = prompt("Enter grams:");
        if(g) handleWeight(parseFloat(g));
    }

    function closeWeight() { document.getElementById('weight-modal').style.display = 'none'; }
    function beep() { new Audio('https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3').play(); }

    function render() {
        const list = document.getElementById('cart');
        list.innerHTML = '';
        let tQty = 0, tDisc = 0, tAmt = 0;

        for (let key in cart) {
            let itm = cart[key];
            let sub = itm.price * itm.qty;
            tQty += itm.isWeight ? 1 : itm.qty;
            tDisc += (itm.mrp - itm.price) * itm.qty;
            tAmt += sub;

            list.innerHTML += `<div class="item-row">
                <div><b>${itm.name}</b><br><small>MRP ₹${itm.mrp}${itm.isWeight?'/kg':''}</small></div>
                <div class="qty-box">
                    <button class="btn-qty" onclick="adj('${key}',-1)">-</button>
                    <b>${itm.isWeight ? (itm.qty*1000)+'g' : itm.qty}</b>
                    <button class="btn-qty" onclick="adj('${key}',1)">+</button>
                    <span style="color:red;padding:10px" onclick="del('${key}')">✕</span>
                </div>
            </div>`;
        }
        document.getElementById('total-qty').innerText = tQty;
        document.getElementById('total-disc').innerText = tDisc.toFixed(2);
        document.getElementById('total-amt').innerText = Math.round(tAmt);
    }

    function adj(k, n) { if(!cart[k].isWeight) { if(cart[k].qty+n > 0) cart[k].qty += n; } render(); }
    function del(k) { delete cart[k]; render(); }

    function generateInvoice() {
        let amt = parseFloat(document.getElementById('total-amt').innerText);
        if(amt <= 0) return;
        dailyProfit += (amt * 0.12); // Tracks your profit target
        localStorage.setItem('dayProfit', dailyProfit);
        document.getElementById('profit-val').innerText = dailyProfit.toFixed(0);
        alert("Invoice Generated! Total: ₹" + amt);
        cart = {}; render();
    }

    loadData();
</script>
</body>
</html>
