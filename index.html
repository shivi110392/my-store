<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Himalayan Glory POS</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <style>
        :root { --primary: #27ae60; --danger: #e74c3c; --bg: #f4f7f6; --text: #333; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: var(--text); overflow: hidden; }
        #camera-section { height: 25vh; background: #000; position: relative; border-bottom: 3px solid var(--primary); }
        #webcam { width: 100%; height: 100%; object-fit: cover; }
        #billing-section { height: 75vh; background: #fff; border-top-left-radius: 25px; border-top-right-radius: 25px; padding: 15px; display: flex; flex-direction: column; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); }
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .item-list { flex-grow: 1; overflow-y: auto; margin-bottom: 10px; border: 1px solid #eee; border-radius: 10px; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f0f0f0; }
        .edit-input { width: 45px; border: 1px solid #ddd; border-radius: 4px; padding: 2px; font-size: 11px; text-align: center; }
        .summary-card { background: #fafafa; padding: 12px; border-radius: 15px; border: 1px solid #eaeaea; }
        .summary-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; }
        .delivery-input { width: 60px; border: 1px solid #ccc; border-radius: 5px; text-align: right; }
        .total-row { font-size: 26px; font-weight: 900; color: #000; border-top: 2px solid #333; margin-top: 8px; padding-top: 8px; }
        .main-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; margin-top: 10px; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:1000; }
        .modal-content { background:#fff; padding:20px; border-radius:15px; width:90%; max-height: 85vh; overflow-y: auto; color: #000; }
        #receipt-box { font-family: 'Courier New', monospace; font-size: 12px; }
        .r-header { text-align: center; border-bottom: 1px dashed #000; padding-bottom: 10px; }
        .r-table { width: 100%; border-collapse: collapse; font-size: 11px; margin: 10px 0; }
        .r-table th { border-bottom: 1px dashed #000; text-align: left; }
        .discount-bar { background: #e0e0e0; padding: 8px; text-align: center; font-weight: bold; margin-top: 10px; border-radius: 4px; }
    </style>
</head>
<body>

<div id="camera-section"><video id="webcam" autoplay playsinline muted></video></div>

<div id="billing-section">
    <div class="header-controls">
        <div class="switch-box"><input type="checkbox" id="tax-toggle" onchange="renderCart()"> <label for="tax-toggle" style="font-weight:bold; font-size:12px;">TAX INVOICE</label></div>
        <button onclick="openHistory()" style="background:#444; color:#fff; border:none; border-radius:8px; padding:5px 10px; font-size:11px;">ðŸ“œ SALES LOG</button>
    </div>
    <div class="item-list" id="cart-items"></div>
    <div class="summary-card">
        <div class="summary-row"><span>Delivery (â‚¹):</span> <input type="number" id="delivery-charge" class="delivery-input" value="0" oninput="renderCart()"></div>
        <div id="gst-info" style="display:none;"><div class="summary-row" style="color:#e67e22;"><span>Total GST:</span> <b>â‚¹<span id="sum-gst">0</span></b></div></div>
        <div class="summary-row" style="color:var(--primary);"><span>Savings:</span> <b>â‚¹<span id="sum-savings">0</span></b></div>
        <div class="summary-row total-row"><span>TOTAL:</span> <span>â‚¹<span id="sum-total">0</span></span></div>
    </div>
    <button class="main-btn" onclick="openInvoicePreview()">PREVIEW & SAVE</button>
</div>

<div id="invoice-modal" class="modal"><div class="modal-content">
    <div id="receipt-box">
        <div class="r-header">
            <h3 style="margin:0;">HIMALAYAN GLORY MINI MART</h3>
            <p style="font-size:9px; margin:2px 0;">Kotgarh House, Main Road, Sector-2, New Shimla, HP 171009</p>
            <div id="gst-header" style="display:none; font-size:9px; font-weight:bold;">GSTIN: 02ERLPS7511E1ZT | Mob: 7876670721</div>
            <h4 style="margin:8px 0; border:1px solid #000; display:inline-block; padding:2px 8px;">CASH MEMO</h4>
            <div style="text-align:left; font-size:10px; font-weight:bold; margin-top:5px; line-height:1.4;">
                <div id="r-date">DATE: 05-02-2026 08:15 PM</div>
                <div id="r-inv">INVOICE: 1001</div>
            </div>
        </div>
        <table class="r-table">
            <thead><tr><th>ITEM</th><th>QTY</th><th>MRP</th><th>RATE</th><th>TOTAL</th></tr></thead>
            <tbody id="r-items-body"></tbody>
        </table>
        <div style="text-align:right; border-top:1px dashed #000; padding-top:8px;">
            <div id="r-gst-break" style="display:none; font-size:11px;"></div>
            <div>Sub Total: Rs <span id="r-sub">0</span></div>
            <div>Delivery: Rs <span id="r-delivery">0</span></div>
            <div style="font-size:16px; font-weight:bold; margin-top:4px;">TOTAL: Rs <span id="r-final">0</span></div>
        </div>
        <div class="discount-bar">DISCOUNT Rs <span id="r-save">0</span> on this purchase</div>
        <div style="text-align:center; margin-top:10px; font-size:10px;">Thank you! Visit Again.</div>
    </div>
    <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="main-btn" onclick="confirmAndSave()">FINISH & NEW BILL</button>
        <button onclick="closeModal('invoice-modal')" style="background:#777; color:white; border:none; border-radius:12px; padding:15px; flex:0.4;">EDIT</button>
    </div>
</div></div>

<div id="history-modal" class="modal"><div class="modal-content">
    <h3 style="margin-top:0;">Sales Ledger</h3>
    <div id="day-summary-box" style="background:#f0f7f0; padding:10px; border-radius:10px; margin-bottom:15px; border:1px solid #cce5cc; font-size:13px;">
        <b>Today's Summary:</b><br>
        Product Sales: â‚¹<span id="day-sales">0</span> | Delivery: â‚¹<span id="day-deliv">0</span><br>
        <span style="font-size:16px; color:#27ae60;">Total Collection: â‚¹<span id="day-total">0</span></span>
    </div>
    <div id="history-list" style="max-height:50vh; overflow-y:auto;"></div>
    <button class="main-btn" style="background:#444;" onclick="closeModal('history-modal')">CLOSE</button>
</div></div>

<script>
    const TEACHABLE_URL = "https://teachablemachine.withgoogle.com/models/cycqkc30S/"; 
    const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQyhBP3yyTYrAJR_-luY7Yr5P7PVKLHRleiH9LWMTASiL7sh0HpZDf2ji5s__ddYcSaS-9aFg5Epz9x/pub?output=csv";
    let inventory = {}, cart = {}, currentInv = parseInt(localStorage.getItem('hg_inv')) || 1001;
    let log = JSON.parse(localStorage.getItem('hg_log')) || [], lastScan = null, lastTime = 0;

    async function init() {
        const res = await fetch(SHEET_CSV);
        const text = await res.text();
        text.split('\n').slice(1).forEach(r => {
            const c = r.split(',');
            if(c[0]) inventory[c[0].trim()] = { name: c[1].trim(), mrp: parseFloat(c[2]), price: parseFloat(c[3]), tax: parseFloat(c[4]) || 0 };
        });
        startAI();
    }

    async function startAI() {
        const model = await tmImage.load(TEACHABLE_URL+"model.json", TEACHABLE_URL+"metadata.json");
        const video = document.getElementById('webcam');
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
        async function loop() {
            const pred = await model.predict(video);
            let top = { probability: 0, className: "" };
            pred.forEach(p => { if(p.probability > top.probability) top = p; });
            if(top.probability > 0.98 && top.className !== "Background") {
                const now = Date.now();
                if(top.className !== lastScan || (now-lastTime) > 3000) { addItem(top.className); lastScan = top.className; lastTime = now; }
            }
            requestAnimationFrame(loop);
        }
        loop();
    }

    function addItem(id) {
        if(!inventory[id]) return;
        if(cart[id]) cart[id].qty++; else cart[id] = JSON.parse(JSON.stringify(inventory[id]));
        if(!cart[id].qty) cart[id].qty = 1;
        new Audio('https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3').play();
        renderCart();
    }

    function renderCart() {
        const list = document.getElementById('cart-items'); list.innerHTML = '';
        let total = 0, savings = 0, gst = 0;
        const taxOn = document.getElementById('tax-toggle').checked;
        for (let k in cart) {
            let itm = cart[k]; let line = itm.price * itm.qty;
            total += line; savings += (itm.mrp - itm.price) * itm.qty;
            gst += line - (line / (1 + (itm.tax/100)));
            list.innerHTML += `<div class="item-row"><div style="flex:1;"><b>${itm.name}</b><br><small>MRP: <input type="number" class="edit-input" value="${itm.mrp}" oninput="updateVal('${k}','mrp',this.value)"> | Rate: <input type="number" class="edit-input" value="${itm.price}" oninput="updateVal('${k}','price',this.value)"></small></div><div style="text-align:right;"><b>x ${itm.qty}</b> <span onclick="delete cart['${k}']; renderCart();" style="color:red;margin-left:5px">âœ•</span></div></div>`;
        }
        const deliv = parseFloat(document.getElementById('delivery-charge').value) || 0;
        document.getElementById('gst-info').style.display = taxOn ? 'block' : 'none';
        document.getElementById('sum-gst').innerText = gst.toFixed(2);
        document.getElementById('sum-savings').innerText = Math.round(savings);
        document.getElementById('sum-total').innerText = Math.round(total + deliv);
    }

    function updateVal(k, f, v) { cart[k][f] = parseFloat(v); renderCart(); }

    function openInvoicePreview(hist = null) {
        const data = hist || cart; if(!Object.keys(data).length) return;
        const taxOn = document.getElementById('tax-toggle').checked;
        const deliv = hist ? hist._deliv : parseFloat(document.getElementById('delivery-charge').value) || 0;
        const itemsBody = document.getElementById('r-items-body'); itemsBody.innerHTML = '';
        let sub = 0, save = 0, gst = 0, i = 1;
        for (let k in data) {
            if(k.startsWith('_')) continue;
            let itm = data[k]; let line = itm.price * itm.qty;
            sub += line; save += (itm.mrp - itm.price) * itm.qty;
            gst += line - (line / (1 + (itm.tax/100)));
            itemsBody.innerHTML += `<tr><td>(${i++}) ${itm.name}</td><td>${itm.qty}</td><td>${itm.mrp}</td><td>${itm.price}</td><td>${line.toFixed(0)}</td></tr>`;
        }
        document.getElementById('gst-header').style.display = taxOn ? 'block' : 'none';
        document.getElementById('r-gst-break').style.display = taxOn ? 'block' : 'none';
        document.getElementById('r-gst-break').innerText = `TOTAL GST: Rs ${gst.toFixed(2)}`;
        document.getElementById('r-sub').innerText = sub.toFixed(0);
        document.getElementById('r-delivery').innerText = deliv;
        document.getElementById('r-final').innerText = Math.round(sub + deliv);
        document.getElementById('r-save').innerText = Math.round(save);
        document.getElementById('r-inv').innerText = (hist ? hist._inv : currentInv);
        document.getElementById('r-date').innerText = "DATE: " + (hist ? hist._date : new Date().toLocaleString('en-IN', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', hour12:true}));
        document.getElementById('invoice-modal').style.display = 'flex';
    }

    function confirmAndSave() {
        let saveCart = JSON.parse(JSON.stringify(cart));
        saveCart._inv = currentInv; saveCart._date = new Date().toISOString();
        saveCart._deliv = parseFloat(document.getElementById('delivery-charge').value) || 0;
        log.push(saveCart); localStorage.setItem('hg_log', JSON.stringify(log));
        window.print();
        currentInv++; localStorage.setItem('hg_inv', currentInv);
        cart = {}; document.getElementById('delivery-charge').value = 0; renderCart(); closeModal('invoice-modal');
    }

    function openHistory() {
        const list = document.getElementById('history-list'); list.innerHTML = '';
        let daySales = 0, dayDeliv = 0;
        const todayStr = new Date().toISOString().split('T')[0];

        log.slice().reverse().forEach((b, idx) => {
            let total = 0; for(let k in b) if(!k.startsWith('_')) total += b[k].price * b[k].qty;
            
            if(b._date.split('T')[0] === todayStr) {
                daySales += total; dayDeliv += b._deliv;
            }

            const displayDate = new Date(b._date).toLocaleString('en-IN', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit', hour12:true});
            list.innerHTML += `<div style="padding:10px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;"><span><b>Inv #${b._inv}</b><br><small>${displayDate}</small></span><b>â‚¹${Math.round(total + b._deliv)}</b><button onclick="openInvoicePreview(log[${log.length-1-idx}])" style="background:var(--primary);color:#fff;border:none;padding:5px 8px;border-radius:5px;">RE-PRINT</button></div>`;
        });
        
        document.getElementById('day-sales').innerText = Math.round(daySales);
        document.getElementById('day-deliv').innerText = Math.round(dayDeliv);
        document.getElementById('day-total').innerText = Math.round(daySales + dayDeliv);
        document.getElementById('history-modal').style.display = 'flex';
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    init();
</script>
</body>
</html>
