<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Himalayan Glory POS</title>
    <script src="https://cdn.jsdelivr.net/npm/@roboflow/inference-sdk@0.2.0/dist/inference-sdk.min.js"></script>
    <style>
        :root { --primary: #2ecc71; --dark: #000; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--dark); color: #fff; height: 100vh; overflow: hidden; }
        #entrance-screen { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; }
        .logo-main { width: 180px; height: 180px; border-radius: 50%; border: 3px solid #333; margin-bottom: 30px; }
        .btn-start { background: var(--primary); color: #000; width: 100%; max-width: 300px; padding: 20px; border-radius: 50px; font-size: 18px; font-weight: 800; border: none; cursor: pointer; }
        #main-app { display: none; height: 100vh; flex-direction: column; background: #fdfdfd; color: #000; }
        #camera-section { height: 35vh; background: #000; position: relative; overflow: hidden; }
        #webcam { width: 100%; height: 100%; object-fit: cover; }
        #debug-text { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: #0f0; padding: 5px 10px; font-family: monospace; font-size: 12px; z-index: 100; pointer-events: none; border-radius: 5px; }
        #progress-bar { position: absolute; top: 0; left: 0; width: 0%; height: 6px; background: var(--primary); transition: width 0.1s; z-index: 10; }
        #billing-section { flex: 1; padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
        .item-list { flex: 1; overflow-y: auto; margin-bottom: 10px; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid #eee; }
        .summary-card { background: #fff; border-radius: 20px; padding: 20px; box-shadow: 0 -5px 25px rgba(0,0,0,0.1); }
        .total-row { display: flex; justify-content: space-between; align-items: center; font-size: 28px; font-weight: 900; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:3000; }
        .popup { background:#fff; padding:30px; border-radius:30px; width:85%; max-width: 400px; text-align: center; }
    </style>
</head>
<body>

<div id="entrance-screen">
    <img src="https://i.ibb.co/6PZ8X7z/IMG-1320.png" class="logo-main">
    <h2 style="margin-bottom: 30px; font-weight: 900;">HIMALAYAN GLORY</h2>
    <button class="btn-start" onclick="startSystem()">LAUNCH SCANNER</button>
</div>

<div id="main-app">
    <div id="camera-section">
        <div id="progress-bar"></div>
        <div id="debug-text">AI Status: Waiting...</div>
        <video id="webcam" autoplay playsinline muted></video>
    </div>
    <div id="billing-section">
        <div class="item-list" id="cart-items">
            <div style="text-align:center; color:#999; margin-top:40px;">Hold product in front of camera</div>
        </div>
        <div class="summary-card">
            <div id="savings-box" style="display:none; color: #27ae60; font-weight: bold; margin-bottom: 10px;">SAVINGS: ₹<span id="sum-savings">0</span></div>
            <div class="total-row"><span>TOTAL</span><span>₹<span id="sum-total">0</span></span></div>
            <button class="btn-start" style="width:100%; margin-top:20px; border-radius:15px;" onclick="location.reload()">CLEAR BILL</button>
        </div>
    </div>
</div>

<div id="qty-modal" class="modal">
    <div class="popup">
        <h2 id="pop-name">Item</h2>
        <div style="display:flex; justify-content:center; align-items:center; gap:25px; margin:20px 0;">
            <button style="width:50px; height:50px; border-radius:50%;" onclick="updateTempQty(-1)">−</button>
            <span id="pop-qty" style="font-size:40px; font-weight:900;">1</span>
            <button style="width:50px; height:50px; border-radius:50%; background:var(--primary);" onclick="updateTempQty(1)">+</button>
        </div>
        <button class="btn-start" style="width:100%;" onclick="addToCart()">ADD TO BILL</button>
    </div>
</div>

<script>
    const CONFIG = {
        roboflow: {
            apiKey: "8n3ZmJUiFbggayPObv7S",
            workspace: "hgmm-pos",
            workflow: "find-cadbury-dairy-milk-10s"
        },
        sheet: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQyhBP3yyTYrAJR_-luY7Yr5P7PVKLHRleiH9LWMTASiL7sh0HpZDf2ji5s__ddYcSaS-9aFg5Epz9x/pub?output=csv"
    };

    let inventory = {}, cart = {}, isScanning = true;
    let tempItem = null, tempQty = 1, lastScan = null, lastTime = 0;

    async function startSystem() {
        document.getElementById('entrance-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        await fetchInventory();
        initCamera();
    }

    async function fetchInventory() {
        try {
            const res = await fetch(CONFIG.sheet);
            const data = await res.text();
            data.split('\n').slice(1).forEach(row => {
                const c = row.split(',');
                if(c[0]) {
                    const cleanName = c[0].trim();
                    inventory[cleanName] = { name: cleanName, mrp: parseFloat(c[5])||0, price: parseFloat(c[6])||0 };
                }
            });
            console.log("Sheet Names Loaded:", Object.keys(inventory));
        } catch(e) { console.error("CSV Load Failed"); }
    }

    async function initCamera() {
        const video = document.getElementById('webcam');
        const debug = document.getElementById('debug-text');
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;
            
            const sdk = window.inference;
            const connector = sdk.connectors.withApiKey(CONFIG.roboflow.apiKey);
            await sdk.webrtc.useStream({
                source: stream,
                connector,
                wrtcParams: {
                    workspaceName: CONFIG.roboflow.workspace,
                    workflowId: CONFIG.roboflow.workflow,
                    imageInputName: "image",
                    dataOutputNames: ["predictions"]
                },
                onData: (data) => {
                    if(isScanning && data.predictions?.length > 0) {
                        const top = data.predictions[0];
                        // DEBUG UI: Shows exactly what the AI sees
                        debug.innerText = `Seeing: ${top.class} (${Math.round(top.confidence*100)}%)`;
                        handleInference(top);
                    } else {
                        debug.innerText = "Searching...";
                    }
                }
            });
        } catch(e) { debug.innerText = "Error: AI not connected"; }
    }

    function handleInference(pred) {
        document.getElementById('progress-bar').style.width = (pred.confidence * 100) + '%';
        if(pred.confidence > 0.80 && pred.class !== "Background") {
            if(pred.class !== lastScan || (Date.now() - lastTime) > 4000) {
                // Check if name exists in inventory
                if(inventory[pred.class]) {
                    isScanning = false; 
                    openQtyPopup(pred.class);
                    lastScan = pred.class; 
                    lastTime = Date.now();
                } else {
                    console.warn(`Mismatch: AI saw "${pred.class}" but it is not in Column 0 of Sheet.`);
                }
            }
        }
    }

    function openQtyPopup(id) {
        tempItem = inventory[id]; tempQty = 1;
        document.getElementById('pop-name').innerText = tempItem.name;
        document.getElementById('pop-qty').innerText = tempQty;
        document.getElementById('qty-modal').style.display = 'flex';
    }

    function updateTempQty(v) { tempQty = Math.max(1, tempQty + v); document.getElementById('pop-qty').innerText = tempQty; }

    function addToCart() {
        const id = tempItem.name;
        if(cart[id]) cart[id].qty += tempQty;
        else cart[id] = { ...tempItem, qty: tempQty };
        document.getElementById('qty-modal').style.display = 'none';
        isScanning = true; renderCart();
    }

    function renderCart() {
        const list = document.getElementById('cart-items'); list.innerHTML = '';
        let total = 0, savings = 0;
        for (const k in cart) {
            const itm = cart[k];
            total += itm.price * itm.qty;
            savings += (itm.mrp - itm.price) * itm.qty;
            list.innerHTML += `<div class="item-row"><span>${itm.name} x${itm.qty}</span><b>₹${itm.price*itm.qty}</b></div>`;
        }
        document.getElementById('sum-total').innerText = Math.round(total);
        if(savings > 0) {
            document.getElementById('savings-box').style.display = 'block';
            document.getElementById('sum-savings').innerText = Math.round(savings);
        }
    }
</script>
</body>
</html>
